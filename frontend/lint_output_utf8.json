[{"filePath":"D:\\Chatbot\\Virtual-Therapist-Chatbot-\\frontend\\src\\layouts\\PrivateRoutes.jsx","messages":[{"ruleId":"no-unused-vars","severity":2,"message":"'isIdsGetSuccess' is assigned a value but never used. Allowed unused vars must match /^[A-Z_]/u.","line":24,"column":73,"nodeType":"Identifier","messageId":"unusedVar","endLine":24,"endColumn":88,"suggestions":[{"messageId":"removeVar","data":{"varName":"isIdsGetSuccess"},"fix":{"range":[1154,1182],"text":""},"desc":"Remove unused variable 'isIdsGetSuccess'."}]},{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'userDetails'. Either include it or remove the dependency array.","line":79,"column":6,"nodeType":"ArrayExpression","endLine":79,"endColumn":47,"suggestions":[{"desc":"Update the dependencies array to be: [userDetails.completed, token, dispatch, userDetails]","fix":{"range":[3040,3081],"text":"[userDetails.completed, token, dispatch, userDetails]"}}]}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { useSelector, useDispatch } from \"react-redux\";\r\nimport { Navigate, Outlet, useLocation } from \"react-router-dom\";\r\nimport { useEffect, useState } from \"react\";\r\nimport { useGetCurrentUserQuery } from \"../slices/auth/authApi\";\r\nimport { logout } from \"../slices/auth/authSlice\";\r\nimport CustomLoader from \"../components/commonComponents/CustomLoader\";\r\nimport { useLazyGetbotChatIdsQuery } from \"../slices/chatbotSlice/chatbotApi\";\r\nimport { setChatbotIds, setLoadingIds } from \"../slices/chatbotSlice/chatbotSlice\";\r\nimport socket from \"../utils/socket\";\r\nimport { addNotification } from \"../slices/NotificationSlice/NotificationSlice\";\r\nimport { jwtDecode } from \"jwt-decode\";\r\n\r\nconst PrivateRoutes = () => {\r\n  const dispatch = useDispatch();\r\n  const location = useLocation();\r\n  const user = useSelector((state) => state.auth.user);\r\n  const userDetails = useSelector((state) => state.auth.userDetails);\r\n  const token = localStorage.getItem(\"Therapy-user-token\");\r\n\r\n  const { isLoading: isUserLoading, isError } = useGetCurrentUserQuery(undefined, {\r\n    skip: !token,\r\n  });\r\n\r\n  const [triggerIds, { data: idsData, isLoading: idsLoading, isSuccess: isIdsGetSuccess }] = useLazyGetbotChatIdsQuery();\r\n  const [fetchedChatIds, setFetchedChatIds] = useState(false);\r\n  const [dispatchedChatIds, setDispatchedChatIds] = useState(false);\r\n\r\n  // Fetch chatbot session IDs once after assessment is completed\r\n  useEffect(() => {\r\n    if (userDetails?.completed && !fetchedChatIds) {\r\n      triggerIds();\r\n      setFetchedChatIds(true);\r\n    }\r\n  }, [userDetails?.completed, fetchedChatIds, triggerIds]);\r\n\r\n  // Dispatch chatbot session IDs to store\r\n  useEffect(() => {\r\n    if (idsData && !dispatchedChatIds) {\r\n      dispatch(setChatbotIds(idsData.data));\r\n      dispatch(setLoadingIds(idsLoading));\r\n      setDispatchedChatIds(true);\r\n    }\r\n  }, [idsData, idsLoading, dispatchedChatIds, dispatch]);\r\n\r\n    // Γ£à Register user on socket after assessment is completed\r\n  useEffect(() => {\r\n    if (userDetails && token) {\r\n      const decodedToken = jwtDecode(token);\r\n      const userIdFromToken = decodedToken?._id;\r\n      if (!socket.connected) socket.connect();\r\n\r\n      const handleConnect = () => {\r\n        console.log(\"udser id :\", userIdFromToken)\r\n        console.log(\"Γ£à Socket connected:\", socket.id);\r\n        socket.emit(\"register\", userIdFromToken);\r\n      };\r\n\r\n      const handleNotification = (data) => {\r\n        console.log(\"≡ƒöö Notification received:\", data);\r\n        dispatch(addNotification(data));\r\n      };\r\n\r\n      const handleError = (err) => {\r\n        console.error(\"Γ¥î Socket error:\", err.message);\r\n      };\r\n\r\n      socket.on(\"connect\", handleConnect);\r\n      socket.on(\"notification\", handleNotification);\r\n      socket.on(\"connect_error\", handleError);\r\n\r\n      // setSocketRegistered(true);\r\n\r\n      return () => {\r\n        socket.off(\"connect\", handleConnect);\r\n        socket.off(\"notification\", handleNotification);\r\n        socket.off(\"connect_error\", handleError);\r\n      };\r\n    }\r\n  }, [userDetails?.completed, token, dispatch]);\r\n\r\n  // Logout and redirect on token error\r\n  if (isError) {\r\n    dispatch(logout());\r\n    return <Navigate to=\"/login\" replace />;\r\n  }\r\n\r\n  // Show loader while checking token or user info\r\n  if (isUserLoading || (token && !user)) {\r\n    return <CustomLoader />;\r\n  }\r\n\r\n  // Redirect unauthenticated users\r\n  if (!token || !user) {\r\n    return <Navigate to=\"/login\" replace />;\r\n  }\r\n\r\n  // Check if accessing dashboard routes - allow if authenticated\r\n  const isDashboardRoute = location.pathname.startsWith(\"/dashboard\") || \r\n                           location.pathname.startsWith(\"/chat\") ||\r\n                           location.pathname.startsWith(\"/mood\") ||\r\n                           location.pathname.startsWith(\"/therapy-plan\") ||\r\n                           location.pathname.startsWith(\"/analytics\") ||\r\n                           location.pathname.startsWith(\"/emergency\") ||\r\n                           location.pathname.startsWith(\"/profile\") ||\r\n                           location.pathname.startsWith(\"/settings\");\r\n\r\n  // If accessing dashboard and user is authenticated, allow access\r\n  if (isDashboardRoute) {\r\n    return <Outlet />;\r\n  }\r\n\r\n  // For /auth/* routes, check assessment completion\r\n  // If userDetails not loaded yet or chatbot IDs still loading\r\n  if (!userDetails || (userDetails?.completed && (!idsData || idsLoading))) {\r\n    return <CustomLoader />;\r\n  }\r\n\r\n  // If userDetails exists but is not completed and trying to access protected routes\r\n  if (location.pathname === \"/auth/user-dashboard\" && userDetails && !userDetails.completed) {\r\n    return <Navigate to=\"/auth/assessment\" replace />;\r\n  }\r\n\r\n  // If current path is \"/\" (root), redirect to first chatbot session\r\n  if (location.pathname === \"/\") {\r\n    const firstChatId = idsData?.data?.[0]?.sessionId || \"new-chat\";\r\n    return <Navigate to={`/auth/chatbot/${firstChatId}`} replace />;\r\n  }\r\n\r\n  // Authenticated and ready ΓÇö show protected content\r\n  return <Outlet />;\r\n};\r\n\r\nexport default PrivateRoutes;\r\n","usedDeprecatedRules":[]}]
